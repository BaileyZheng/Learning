# TCP/IP详解卷1：协议读书笔记
## 一、概述
### 1.1分层
TCP/IP通常被认为是一个四层协议系统：

![TCP/IP协议族的四个层次](https://github.com/18862601653/Learning/blob/master/images/tcpip/2018-04-10_093055.png)

每一层负责不同的功能：
- 链路层，也称作数据链路层或网络接口层，通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。它们一起处理与电缆（或其他任何传输媒介）的物理接口细节。
- 网络层，也称作互联网层，处理分组在网络中的活动，如分组的选路。

  在TCP/IP协议族中，网络层协议包括IP协议（网际协议），ICMP协议（Internet互联网控制报文协议）以及IGMP协议（Internet组管理协议）。

- 运输层，主要为两台主机上的应用程序提供端到端的通信。

  在TCP/IP协议族中，有两个互不相同的传输协议：TCP（传输控制协议）和UDP（用户数据报协议）。

  TCP为两台主机提供高可靠性的数据通信，它所做的工作包括把应用程序交给它的数据分成合适的小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组的超时时钟等。由于运输层提供了高可靠性的端到端的通信，因此应用层可以忽略所有这些细节。

  UDP为应用层提供一种非常简单的服务。它只是把称作数据报的分组从一台主机发送到另一台主机，但并不保证该数据报能到达另一端。任何必需的可靠性必须由应用层来提供。

- 应用层，负责处理特定的应用程序细节。

  几乎各种不同的TCP/IP实现都会提供以下这些通用的应用程序：

  Telnet远程登录、FTP文件传输协议、SMTP简单邮件传送协议、SNMP简单网络管理协议

下面以一个局域网（LAN）中两台主机都运行FTP协议为例，列出该过程涉及的所有协议。
![局域网上运行FTP的两台主机](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-10_122007.png)

值得注意的是：
- 大多数的网络应用程序都被设计成客户-服务器模式，服务器为客户提供某种服务，本例中是访问服务器所在主机上的文件。在远程登录应用层程序Telnet中，为客户提供的服务是登录到服务器主机上。
- 在同一层上，双方都有对应的一个或多个协议进行通信
- 应用程序通常是一个用户进程，下三层一般在（操作系统）内核中执行。这不是必须的，但通常都是这样处理。
- 应用层关心的是应用程序的细节，而不是数据在网络中的传输活动；下三层对应用一无所知，但它们要处理所有的通信细节。

单个计算机构成的孤岛没有意义，所以将这些计算机组在一起形成网络，但是由单个网络构成的新的更大的岛屿也没有意义，所以将多个网络连接在一起形成互联网。而所谓的互联网就是一组通过相同协议族互连在一起的网络。构建互联网最简单的方法就是把两个或多个网络通过路由器进行连接。路由器的好处是为不同的物理网络提供连接：以太网、令牌环网、点对点的链接和FDDI（光纤分布式数据接口）等。

令牌环网（Token-ring network），常用于IBM系统中，在这种网络中，有一种专门的帧称作“令牌”，在环路上持续地传输来确定一个结点何时可以发送包。

为什么要将网络层和运输层进行划分？
  - 划分端系统和中间系统：应用层和运输层使用端到端协议，只有端系统需要这两层协议，但是网络层提供的是逐跳协议，两个端系统和每个中间系统都要使用它。
  - 运输层和网络层负责不同的功能：网络层IP提供的是一种不可靠的服务，它只是尽可能快地将分组从源结点送到目的结点，而不提供任何可靠性保证。TCP在不可靠的IP层上提供了一个可靠的运输层，为了提供这种可靠的服务，TCP采用了超时重传、发送和接收端的确认分组等机制。

互联网的目的之一是在应用程序中隐藏所有的物理细节。

除了路由器以外，网桥也可以用来连接网络，网桥是在链路层上对网络进行互连，而路由器是在网络层上对网络进行互连。网桥使得多个局域网（LAN）组合在一起，这对上层来说就好像是一个局域网。TCP/IP倾向于使用路由器而不是网桥连接网路。

### 1.2 TCP/IP的分层

![TCP/IP协议族中不同层次的协议](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-16_084642.png)

- TCP和UDP是两种最为著名的运输层协议，二者都使用IP作为网络层协议。虽然TCP使用不可靠的IP服务，但它提供的是一种可靠的运输层服务。UDP为应用程序发送和接收数据报，一个数据报是指从发送方传输到接收方的一个信息单元（如，发送方指定的一定字节数的信息），但是与TCP不同的是，UDP是不可靠的，不能保证数据报安全无误地到达最终目的。

- IP是网络层上的主要协议，同时被TCP和UDP使用。TCP和UDP的每组数据都通过端系统和每个中间路由器中的IP层在互联网中进行传输。应用程序可以直接访问IP，但是很少见。

- ICMP是IP协议的附属协议，IP层用它来与其他主机或路由器交换错误报文和其他重要信息。尽管ICMP主要被IP使用，但是应用程序也能访问它，像Ping和Traceroute都使用了ICMP。

- IGMP是Internet组管理协议，它用来把一个UDP数据报多播到多个主机。

- ARP（地址解析协议）和RARP（逆地址解析协议）是某些网络接口使用的特殊协议，用来转换IP层和网络接口层使用的地址。

### 1.3 互联网的地址
互联网上的每个接口必须有个唯一的Internet地址（IP地址），IP地址长32位。

![五类不同的IP地址](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-17_222653.png)

IP地址具有一定的结构，32位的地址通常写成四个十进制的数，每个整数对应一个字节，这种表示方法称作“点分十进制”。区分各类地址的最简单方式就是看它的第一个十进制整数。
- A类地址范围：0.0.0.0到127.255.255.255
- B类地址范围：128.0.0.0到191.255.255.255
- C类地址范围：192.0.0.0到223.255.255.255
- D类地址范围：224.0.0.0到239.255.255.255
- E类地址范围：240.0.0.0到247.255.255.255

多接口主机具有多个IP地址，其中每个接口都对应一个IP地址。由于互联网上的每个接口必须有一个唯一的IP地址，因此必须要有一个管理机构为接入互联网的网络分配IP地址。这个管理机构就是互联网络信息中心（InterNIC，Internet Network Information Centre）。InterNIC只分配网络号，主机号的分配由系统管理员来负责。NIC负责处理国防数据网的注册请求，其他的Internet用户注册请求均由InterNIC负责处理。InterNIC由注册服务、目录和数据库服务以及信息服务组成。

IP地址有三类：
- 单播地址，目的为单个主机
- 广播地址，目的端为给定网络上的所有主机
- 多播地址，目的端为同一组内的所有主机

### 1.4 域名系统
域名系统DNS是一个分布的数据库，由它来提供IP地址和主机名之间的映射信息。

任何应用程序都可以调用一个标准的库函数来查看给定名字的主机的IP地址，类似的，系统还提供一个逆函数，给定主机的IP地址，查看其所对应的主机名。

### 1.5 封装
当应用程序用TCP传送数据的时候，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）。

![数据进入协议栈时的封装过程](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-17_224758.png)

TCP传给IP的数据单元称作TCP报文段或简称（TCP段），IP传给网络接口层的数据单元称作IP数据报，通过以太网传输的比特流称作帧。

以太网数据帧的物理特性是其长度必须在46~1500字节之间。

*octet这个术语表示字节

IP和网络接口层之间传送的数据单元是分组，分组可以是一个IP数据报，也可以是IP数据报的一个片。

UDP数据与TCP数据基本一致，唯一的区别是UDP传给IP的信息单元称作UDP数据报，而且UDP的首部长为8字节。

由于TCP、UDP、ICMP和IGMP都要向IP传送数据，所以IP必须在生成的IP首部中加入某种标识，以表明数据属于哪一层。所以IP在首部中存入一个长度为8bit的数值，称为协议域。1表示ICMP协议i，2表示IGMP协议，6表示TCP协议，17表示UDP协议。

同理，许多应用程序都可以使用TCP或UDP来传送数据，运输层协议在生成报文首部时要存入一个应用程序的标识符。TCP和UDP都用一个16bit的端口号来表示不同的应用程序。TCP和UDP把源端口号和目的端口号分别存入报文首部中。

网络接口分别要发送和接收IP、ARP和RARP数据，因此也必须在以太网的帧首部中加入标识，以指明生成数据的网络层协议，因此以太网的帧首部有一个16bit的帧类型域。

### 1.6 分用
当目的主机收到一个以太网数据帧时，数据就从协议栈由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作分用。

![以太网数据帧的分用过程](https://github.com/Balabalabalala/Learning/images/2018-04-17_225857.png)

ICMP和IGMP一方面是IP的附属协议，另一方面，ICMP和IGMP报文都被封装在IP数据报中。

ARP和RARP一方面和IP数据报一样拥有各自的以太网数据帧类型，另一方面ARP又是以太网设备驱动程序的一部分。

### 1.7 客户-服务器模型
客户服务器模型指网络应用程序在编写时假设一端是客户，另一端是服务器，其目的是让服务器为客户提供一些特定的服务。

服务可分为两种类型：
- 重复型

重复型服务器的交互步骤：

1）等待一个客户请求的到来

2）处理客户请求（此时它不能为其他客户机提供服务）

3）发送响应给发送请求的客户

4）返回第一步

- 并发型

并发服务器采用以下步骤：

1）等待一个客户请求的到来

2）启动一个新的服务器来处理这个客户的请求，在此期间可能生成一个新的进程、任务或线程，并依赖底层操作系统的支持。生成的新服务器对客户的全部请求进行处理，处理结束后，终止这个新服务器

3）返回第一步

并发服务器的优点：

它是利用生成其他服务器的方法来处理客户的请求，每个客户都有它自己对应的服务器，如果操作系统允许多任务，就可以同时为多个客户服务。

客户通常不能识别自己是与一个重复型服务器或并发型服务器进行对话。

一般情况下，TCP服务器是并发的，而UDP服务器是重复的。

### 1.8 端口号
服务器一般通过知名端口号识别应用程序，对于每个TCP/IP实现来说，FTP服务器的TCP端口号是21，每个Telnet服务器的TCP端口号是23，每个TFTP服务器的UDP端口号是69.任何TCP/IP实现所提供的服务都用知名的1~1023之间的端口号。这些知名端口号由Internet号分配机构（IANA，Internet Assigned Numbers Authority）来管理。

客户端对它所使用的端口号并不关心，只需保证该端口号在本机上是唯一的就行，客户端口号又称作临时端口号（存在时间很短暂），因为它通常只是在用户运行该客户程序时才存在，而服务器则只要处于开机状态，其服务就运行。

大多数TCP/IP实现给临时端口分配1024~5000之间的端口号，大于5000的端口号为其他服务器预留。但是也有例外，如Solaris2.2，其TCP和UDP缺省临时端口号从32768开始。

Unix系统文件/etc/services包含熟知的端口号
```
grep telnet /etc/services
列出telnet使用的端口号
```

### 1.9 标准化过程
负责Internet技术的四个小组：
- Internet协会（ISOC，Internet Society）：推动、支持和促进Internet不断增长和发展，把Internet作为全球研究通信的基础设施
- Internet体系结构委员会（IAB，Internet Architecture Board）：技术监督和协调，隶属于ISOC
- Internet工程专门小组（IETF，Internet Engineering Task Force）：面向近期标准，分9个领域（应用、寻径和寻址、安全等），隶属于IAB
- Internet研究专门小组（IRIF，Internet Research Task Force）：对长远的项目进行研究，隶属于IAB

### 其他

标准的简单服务及其他标准的TCP/IP服务的端口号为奇数的原因：

这些端口号从NCP（网络控制协议，是ARPANET的运输层协议，TCP的前身）端口号派生出来，而NCP是单工的，所以每个应用程序需要两个连接，需要预留一对奇数和偶数端口号。当TCP和UDP成为标准的运输层协议时，每个应用程序只需要一个端口号，因此就使用了NCP中的奇数。

internet表示用一个共同的协议族把多个网络连接在一起，而Internet表示世界范围内通过TCP/IP互相通信的所有主机集合（超过100万台）。Internet是一个internet，而internet不等于Internet。

TCP/IP协议的应用程序通常采用两种应用编程接口（API）：socket和TLI（运输层接口）

### 小结
TCP/IP协议族分四层：链路层、网络层、运输层和应用层，每一层各有不同的责任。

网络层（IP）提供点到点的服务，运输层（TCP和UDP）提供端到端的服务。

互联网是网络的网络，路由器是构造互联网的基石，它们在IP层将网络连在一起。

在一个互联网上，每个接口都用IP地址来标识，域名系统为主机名和IP地址之间提供动态的映射。

端口号用来标识互相通信的应用程序。

服务器使用指明端口号，而客户使用临时设定的端口号。

## 二、链路层
链路层主要有三个目的：
- 为IP模块发送和接收IP数据报
- 为ARP模块发送ARP请求和接收ARP应答
- 为RARP发送RARP请求和接收RARP应答

以太网是当今TCP/IP采用的主要的局域网技术，采用一种称作CSMA/CD的媒体接入方法，即带冲突检测的载波侦听多路接入，它的速率为10Mb/s,地址为48bit。

802标准集：
- 802.3：针对整个CSMA/CD网络
- 802.4：针对令牌总线网络
- 802.5：针对令牌环网络
- 802.2：定义三者的共同特性，共有的逻辑链路控制（LLC）

以太网IP数据报的封装是在RFC894中定义的，IEEE 802网络的IP数据报封装是在RFC 1024中定义的。

主机需求RFC要求每台Internet主机都与一个10Mb/s的以太网电缆相连接：
- 必须能发送和接收采用RFC 894（以太网）封装格式的分组
- 应该能接收与RFC 894混合的RFC 1024（IEEE 802）封装格式的分组
- 也许能发送采用RFC 1024格式封装的分组，如果主机能同时发送两种类型的分组数据，那么发送的分组必须是可以设置的，而且默认条件下必须是RFC 894分组。

RFC 894是最常用的封装格式。

![IEEE 802.2/802.3（RFC 1024）和以太网的封装格式（RFC 894）](https://github.com/Balabalabalala/Learning/images/2018-04-18_093627.png)

两种帧格式都采用48bit（6字节）的目的地址和源地址，802.3允许使用16bit的地址，但一般是48bit地址。

802标准定义的帧格式中，长度字段指的是它后续数据的字节长度，但不包括CRC检验码；以太网的类型字段定义了后续数据的类型。在802标准定义的帧格式中，类型字段由后续的子网接入协议（SNAP，Sub-network Access Protocol）的首部给出。由于802定义的有效长度值与以太网的有效类型值无一相同，所以可以对两种帧格式进行区分。

在以太网帧格式中，类型字段之后就是数据；而在802帧格式中，跟随在后面的是3字节的802.2 LLC和5字节的802.2 SNAP。目的服务访问点（DSAP，Destination Service Access Point）和源服务访问点（SSAP，Source Service Access Point）的值都设为0xaa。Ctrl字段的值设为3，随后的3个字节org code都置为0.再接下来的2个字节类型字段和以太网帧格式一样。

CRC字段用于帧内后续字节差错的循环冗余码检验（检验和）（也被称为FCS或帧检验序列）

802规定数据部分必须至少为38字节，以太网要求至少46字节。在不足的空间插入填充（pad）字节。

*尾部封装：将以太网数据帧中开始的那部分变长的字段（IP首部和TCP首部）移到尾部（CRC前），这样把数据复制到内核时，可以把数据帧中的数据部分映射到一个硬件页面，节省内存到内存的复制过程。TCP数据报的长度是512字节的整数倍，正好可以用内核中的页表来处理。两台主机通过协商使用ARP扩展协议对数据帧进行尾部封装。这些数据帧需定义不同的以太网帧类型值。但遭到反对。*

### SLIP
SLIP（Serial Line IP，串行线路IP），是一种在串行线路上对IP数据报进行封装的简单形式，适用于家庭中每台计算机几乎都有的RS-232串行接口和高速调制解调器接入Internet。  
SLIP协议定义的帧格式：  
- IP数据报以一个称作END（0xc0）的特殊字符结束。为了防止数据报到来之前的线路噪声被当成数据报内容，在数据报的开始处也传一个END字符（在有噪声的情况下，END字符结束这份错误的报文，错误的报文交给上层后，发现其内容无意义而丢弃）  
- 如果IP报文中某个字符为END，就连续传输两个字节0xdb和0xdc，0xdb被称作SLIP的ESC字符，但它与ASCII码的ESC字符（0x1b）不同  
- 如果IP报文中某个字符为SLIP的ESC字符，就连续传输两个字节0xdb和0xdd  
![SLIP报文的封装](https://github.com/Balabalabalala/Learning/images/2018-04-18_101101.png)  
图中串行线路上传输的总字节数是原IP报文长度再加4个字节。  
SLIP的缺陷：  
- 每一端必须知道对方的IP地址，没办法把本端的IP地址通知给另一端  
- 数据帧中没有类型字段，如果一条串行线路用于SLIP，则它不能同时使用其他协议  
- SLIP没有在数据帧中加检验和，如果SLIP传输的报文被线路噪声影响发生错误，需要上层协议发现（或调制解调器检测并纠正错误报文），这样上层协议提供某种形式的CRC就很重要。IP和TCP首部及其数据都有检验和，UDP首部及其数据的检验和是可选的。

SLIP简单并使用广泛。  

CSLIP（压缩SLIP）：  
由于串行线路速率低（19200b/s或更低），并且通信常是交互式的（Telnet、Rlogin，都使用TCP），所以SLIP线路上有许多小的TCP分组进行交换。为了传送1个字节的数据需要20个字节的IP首部和20个字节的TCP首部，总数超过40个字节。  
为了解决以上问题，CSLIP把40个字节压缩到3或5个字节，能在CSLIP的每一端维持多达16个TCP连接，并且知道其中每个连接的首部中的某些字段一般不会发生变化。对于发生变化的字段，大多数只是一些小的数字和的改变，被压缩的首部大大地缩短了交互响应时间。  
SLIP一般提供基于服务类型的排队方法，允许对交互通信数据在处理大块数据之前进行处理。由于大多数的实现都不使用TOS字段，因此这种排队机制由SLIP自己来判断和处理，驱动程序先查看协议字段（确定是否是一个TCP段），然后检测TCP信源和信宿的端口号，以判断是否是一个交互服务。

### PPP协议
PPP，点对点协议，修改了SLIP的所有缺陷。PPP包括以下三部分：  
- 在串行链路上封装IP数据报的方法，PPP既支持数据为8位和无奇偶检验的异步模式，也支持面向比特的同步链接  
- 建立、配置及测试数据链路的链路控制协议（LCP：Link Control Protocol），允许通信双方进行协商，以确定不同的选项  
- 针对不同网络层协议的网络控制协议（NCP，Network Control Protocol）体系。  
![PPP数据帧的格式](https://github.com/Balabalabalala/Learning/images/PPP数据帧的格式.jpg)  
PPP数据帧格式：  
- 每一帧都以标志字符0x7e开始和结束，紧接着是一个地址字节，值始终是0xff，然后是一个值为0x03的控制字节。  
- 协议字段，当其值为0x0021时，表示信息字段是一个IP数据报，值为0xc021时，表示信息字段是链路控制数据，值为0x8021时，表示信息字段是网络控制数据。  
- CRC字段（FCS，帧检验序列）是一个循环冗余检验码，检测数据帧中的错误。  

标志字符0x7e出现在信息字段中时的转义：  
- 同步链路中，通过比特填充（bit stuffing）的硬件技术完成  
- 异步链路中，用0x7d作为转义字符（紧接着的字符的第6个比特取补码，如0x7e->0x7d 0x 5e）  
- 原因：防止它们出现在双方主机的串行接口驱动程序或调制解调器中，因为有时它们会把这些控制字符解释成特殊的含义  
- 可以使用链路控制协议指定是否需要对这32个字符中的某些值进行转义，默认情况下是对所有的32个字符都进行转义  

PPP与SLIP的比较：  
- 与SLIP类似，PPP常用于低速的串行链路，所以减少每一帧的字节数可以降低应用程序的交互时延，利用链路控制协议，通过协商可以省略标识符和地址字段并把协议字段由两个字节减少到1个字节  
- PPP比SLIP的帧格式增加3个额外字节：一个留给协议字段，另两个给CRC字段使用  
- PPP比SLIP优点1：PPP支持在单根串行线路上运行多种协议，不只是IP协议   
- 优点2：每一帧都有循环冗余检验  
- 优点3：通信双方可以使用IP网络控制协议进行IP地址的动态协商  
- 优点4：与CSLIP类似，对TCP和IP报文首部进行压缩  
- 优点5：链路控制协议可以对多个数据链路选项进行设置  

### 环回接口
Loopback Interface允许运行在同一台主机上的客户程序和服务器程序通过TCP/IP进行通信。A类网络号127就是为环回接口预留的，127.0.0.1这个IP地址分配给这个接口，命名为localhost，一个传给环回接口的IP数据报不能在任何网络上出现。大多数产品对于目的端地址为环回地址的情况，会完成传输层和网络层的所有过程，当IP数据报离开网络层时把它返回给自己。  
![环回接口处理IP数据报的过程](https://github.com/Balabalabalala/Learning/images/环回接口处理IP数据报的过程.jpg)  
注意：  
- 传给换回地址（127.0.0.1）的任何数据均作为IP输入  
- 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上，因为广播传送和多播传送的定义包含主机本身  
- 任何传给该主机IP地址的数据均送到环回接口  

环回接口可被看作是网络层下面的另一个链路层，网络层把一份数据报传送给环回接口，就像传给其他链路层一样，不过环回接口把它返回到IP的输入队列中。  
送给主机本身IP地址的IP数据报一般不出现在相应的网络上。  

### 最大传输单元MTU
不同类型的网络大多数都有链路层的MTU这个性质，以下是几种常见的MTU：  

|网络|MTU字节|
|-|-|
|超通道|65535|
|16Mb/s令牌环（IBM）|17914|
|4Mb/s令牌环（IEEE 802.5）|4464|
|FDDI|4352|
|以太网|1500|
|IEEE 802.3/802.2|1492|
|X.25|576|
|点对点（低时延）|296|

如果IP层有一个数据报的长度比链路层的MUT大，那么IP层就要进行分片，把数据报分成若干片，每一片都小于MTU。  
当两个主机之间的通信要通过多个网络的时候，每个网络的链路层可能有不同的MTU，两台通信主机路径中最小的MTU就是路径MTU。  
两台主机之间的路径MTU不一定是个常数，它取决于当时所选择的路由，而选路不一定是对称的，因此路径MTU在两个方向上不一定是一致的。  

TCP/IP成功的原因之一就是它几乎能在任何数据链路技术上运行。  

## 三、IP网际协议
所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。  
IP提供不可靠的数据传输服务的意思是它不能保证IP数据报成功到达目的地，IP仅提供最好的传输服务，如果发生某种错误，如某个路由器暂时用完了缓冲区，IP处理错误的算法是：丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层提供（如TCP）。  
IP提供无连接的数据传送服务的意思是IP不维护任何关于后续数据报的状态信息，每个数据报的处理都是相对独立的。也说明IP数据报可以不按发送顺序接收，如果一信源向相同的信宿发送两个连续的数据报，每个数据报都是独立地进行路由选择，可能选择不同的路线，并且后发送的数据报可能在先发送的数据报之前到达。  
### IP首部
![IP数据报格式及首部中的各字段.jpg](https://github.com/Balabalabalala/Learning/images/IP数据报格式及首部中的各字段.jpg)  
普通的IP首部长20个字节。最高位在左边，记为0bit，最低位在右边，记为32bit。  
4个字节的32bit值以下面的次序传输：  
- 0~7bit  
- 8~15bit  
- 16~23bit  
- 24~31bit  
这种传输次序称作大端（big endian）字节序。因为TCP/IP首部中所有的二进制整数在网络中传输时都要求以这种次序，所以又称作网络字节序。以其他形式存储二进制整数的机器，如little endian格式，则必须在传输数据之前把首部转换成网络字节序。  
首部字段：  
- 协议版本号：为4的时候IP称作IPv4  
- 首部长度：首部占32bit字的数目，包括任何选项。由于其是4bit字段，所以首部最长为60个字节（4bit最大表示15，15 * 32bit/8bit = 60字节）。普通IP数据报的字段值为5.  
- 服务类型（TOS）字段：包括一个3bit的优先权子字段（现已被忽略），4bit的TOS子字段和1bit未用位（必须置0），其中4bit的TOS分别代表最小时延、最大吞吐量、最高可靠性和最小费用，4bit中只能置其中1bit，如果所有4bit都是0，那就意味着一般服务。  
下表列出了不同应用建议的TOS值，最后一列给出的十六进制值是tcpdump命令输出： 

|应用程序|最小时延|最大吞吐量|最高可靠性|最小费用|16进制值|
|-|-|-|-|-|-|
|Telnet/Rlogin|1|0|0|0|0x10|
|FTP控制|1|0|0|0|0x10|
|FTP数据|0|1|0|0|0x08|
|任意块数据|0|1|0|0|0x08|
|TFTP|1|0|0|0|0x10|
|SMTP命令阶段|1|0|0|0|0x10|
|SMTP数据阶段|0|1|0|0|0x08|
|DNS UDP查询|1|0|0|0|0x10|
|DNS TCP查询|0|0|0|0|0x00|
|DNS 区域传输|0|1|0|0|0x08|
|ICMP差错|0|0|0|0|0x00|
|ICMP查询|0|0|0|0|0x00|
|ICMP任何IGP|0|0|1|0|0x04|
|SNMP|0|0|1|0|0x04|
|BOOTP|0|0|0|0|0x00|
|NNTP|0|0|0|1|0x02|

Telnet和Rlogin这两个交互应用要求最小的传输时延，因为人们主要用它们来传输少量的交互数据，而FTP文件传输则要求有最大的吞吐量，最高可靠性被指明给网络管理（SNMP）和路由选择协议，用户网络新闻（Usenet news，NNTP）是唯一要求最小费用的应用。  
- 总长度字段：整个IP数据报的长度，以字节为单位，利用首部长度字段和总长度字段就可以知道IP数据报中数据内容的起始位置和长度。由于该字段长16bit，所以IP数据报最长可达65535字节（超级通道的MTU为65535，它使用了最长的IP数据报）。当数据报被分片时，该字段的值也随着变化。虽然  可以传送长达65535字节的IP数据报，但是大多数的链路层都会对它进行分片，而且主机也要求不能接收超过576字节的数据报。由于TCP把用户数据分成若干片，因此一般来说这个限制不会影响TCP，像RIP、TFTP、BOOTP、DNS以及SNMP这种大量使用UDP的应用都限制用户数据报长度为512字节，小于576字节。但是事实上现在大多数的实现允许超过8192字节的IP数据报。  
总长度字段是IP首部中必要的内容，因为一些数据链路（如以太网）需要填充一些数据以达到最小长度，尽管以太网的最小帧长为46字节，但是IP数据可能会更短，如果没有总长度字段，那么IP层就不知道46字节中有多少是IP数据报的内容。  
- 标识字段：唯一地标识主机发送的每一份数据报。通常每发送一份报文它的值就会加1.  
- TTL（time-to-live）生存时间字段：设置数据报可以经过的最多路由器数，指定了数据报的生存时间，TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，它的值就减去1，当该字段的值为0时，数据报就被丢弃，并发送ICMP报文通知源主机。  
- 协议字段：根据它可以识别哪个协议向IP传送数据。  
- 首部检验和字段：根据IP首部计算的检验和码，不对首部后面的数据进行计算。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码，它们都采用相同的检验和算法。  
计算数据报的IP检验和：首先把检验和字段置为0，然后对首部中每个16bit进行二进制反码求和（整个首部看成是由一串16bit的字组成），结果存在检验和字段中。当收到一份IP数据报后，同样对首部中每个16bit进行二进制反码求和。由于接收方在计算过程中包含了发送方存在首部中的检验和，因此，如果首部在传输过程中没有发生任何差错，那么接收方计算的结果应该为全1，如果结果不是全1（即检验和错误），那么IP就丢弃收到的数据报，但是不生成差错报文，由上层去发现丢失的数据报并进行重传。  
由于路由器经常只修改TTL字段（减1），因此当路由器转发一份报文时可以增加它的检验和，而不需要对IP整个首部进行重新计算。  
- 源IP地址和目的IP地址：都是32bit的值。  
- 任选项：是数据报中的一个可变长的可选信息。任选项的定义包括：安全和处理限制（用于军事领域）、记录路径（让每个路由器都记下它的IP地址）、时间戳（让每个路由器都记下它的IP地址和时间）、宽松的源站选路（为数据报指定一系列必须经过的IP地址）和严格的源站选路（只能经过指定的这些地址，不能经过其他地址）。这些选项很少被使用，并非所有的主机和路由器都支持这些选项。选项字段以32bit作为界限，必要时插入值为0的填充字节，从而保证IP首部始终是32bit的整数倍。  

### IP路由选择
IP路由选择是简单的，特别对于主机来说，如果目的主机与源主机直接相连（点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报就直接送到目的主机上，否则，主机将数据报发往一个默认的路由器上，由路由器转发该数据报。大多数的主机都是采用这种简单机制。  
IP层既可以配置成路由器的功能，也可以配置成主机的功能。大多数的用户系统都可以配置成一个路由器，可以为它指定主机和路由器都可以使用的简单路由算法，本质上的区别在于主机从不把数据报从一个接口转发到另一个接口，而路由器要转发数据报。内含路由器功能的主机应该从不转发数据报，除非它被设置成那样。  
在一般的体制中，IP可以从TCP、UDP、ICMP和IGMP接收数据报（在本地生成的数据报）并进行发送，或者从一个网络接口接收数据报（待转发的数据报）并进行发送。IP层在内存中有一个路由表，当收到一份数据报并进行发送时，它都要对该表搜索一次。当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就被送到由IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么如果IP层被设置为路由器功能，就对数据报进行转发，否则数据报被丢弃。  
路由表中的每一项都包含以下信息：
- 目的IP地址。既可以是一个完整的主机地址，也可以是一个网络地址，由该表目中的标志字段来指定。主机地址有一个非0的主机号，以指定某一特定的主机，而网络地址中的主机号为0，以指定网络中的所有主机（以太网，令牌环网）。  
- 下一站（下一跳）路由器（next-hop router）的IP地址，或者有直接连接的网络IP地址。下一站路由器是指一个在直接相连网络上的路由器，通过它可以转发数据报。下一站路由器不是最终的目的，但是它可以把传送给它的数据报转发到最终目的。  
- 标志。其中一个标志指明目的IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口。  
- 为数据报的传输指定一个网络接口。  
IP路由选择是逐跳地（hop-by-hop）进行的，IP并不知道到达任何目的的完整路径（除非是与主机直接相连的目的），所有的IP路由选择只为数据报传输提供下一站路由器的IP地址。它假定下一站路由器比发送数据报的主机更接近目的，而且下一站路由器与该主机是直接相连的。  
IP路由选择主要完成以下功能：
- 搜索路由表，寻找能与目的IP地址完全匹配的表目（网络号和主机号都要匹配），如果找到，则把报文发送给该表明指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。  
- 搜索路由表，寻找能与目的网络号相匹配的表目，如果找到，则把报文发送给该表目指定的下一跳路由器或直接连接的网络接口（取决于标志字段的值），目的网络上的所有主机都可以通过这个表目来处置。例如，一个以太网上的所有主机都是通过这种表目进行寻径的。这种搜索网络的匹配方法必须考虑可能的子网掩码。  
- 搜索路由表，寻找标为“默认（default）”的表目，如果找到，则把报文发送给该表目指定的下一站路由器。  
如果上述步骤都不成功，那么该数据报就不能被传送。如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。  
IP路由选择机制的特性：  
- 完整主机地址匹配在网络号匹配前执行，只有当它们都失败后才选择默认路由，默认路由，以及下一站路由器发送的ICMP间接报文（如果为数据报选择了错误的默认路由），是IP路由选择机制中功能强大的特性。  
- 为一个网络指定一个路由器，而不必为每个主机指定一个路由器，这是IP路由选择机制的另一个基本特性。这么做可以极大地缩小路由表的规模。  
在同一个以太网上两个主机数据传输过程图：
![数据报从主机bsdi到sun的传送过程](https://github.com/Balabalabalala/Learning/images/2018-04-18_154035.png)  
不在同一个以太网上两个主机数据传输过程图：  
![从bsdi到ftp.uu.net(192.48.96.9)的初始路径](https://github.com/Balabalabalala/Learning/images/2018-04-18_181447.png)  
对于上例的一些关键点：  
- 所有主机和路由器都使用了默认路由，大多数主机和一些路由器可以用默认路由来处理任何目的，除非它在本地局域网上。  
- 数据报中的目的IP地址始终不发生任何变化，所有的路由选择决策都是基于这个目的IP地址。  
- 每个链路层可能具有不同的数据帧首部，而且链路层的目的地址始终指的是下一站的链路层地址。以太网地址一般通过ARP获得。  
### 子网寻址
现在所有的主机都要求支持子网编址，不是把IP地址看成由单纯的一个网络号和一个主机号组成，而是把主机号再分成一个子网号和一个主机号。  
这么做的原因是：A类和B类地址为主机号分配了太多的空间，可分别容纳的主机数为2^24-2和2^16-2（全0或全1的主机号无效）.事实上，在一个网络中并不安排这么多的主机。  
在InterNIC获得某类IP网络号后，由当地的系统管理员来进行分配，由他决定是否建立子网，以及分配多少比特给子网号和主机号。  
![B类地址的一种子网编址](https://github.com/Balabalabalala/Learning/images/B类地址的一种子网编址.jpg)  
此B类网络地址（140.252）剩下的16bit中，8bit用于子网号，8bit用于主机号，允许有254个子网，每个子网可以有254台主机。  
大多数的子网例子都是B类地址，因为C类可用的比特数较少，A类地址本身就很少。  
子网对外部路由器来说隐藏了内部网络组织的细节。  
![网络noao.edu(140.252)中的大多数子网安排](https://github.com/Balabalabalala/Learning/images/网络noao.edu(140.252)中的大多数子网安排.jpg)  
采用子网的好处是，可以由一台路由器提供Internet的接入，从而可以缩小Internet路由表的规模。B类地址140.252被划分为若干子网的事实对于所有子网以外的Internet路由器都是透明的。但是  子网对于子网内部的路由器是不透明的。如，一份来自Internet的数据报到达gateway，它的目的地址是140.252.57.1，路由器gateway需要知道子网号是57，然后把它送到kpno，同样，kpno必须把数据报送到R55，最后由R55把它送到R57.  

### 子网掩码
任何主机在引导时进行的部分配置是指定主机IP地址。大多数系统把IP地址存在一个磁盘文件里供引导时读用。  
除了IP地址以外，主机还需要知道有多少比特用于子网号及多少比特用于主机号。这是在引导过程中通过子网掩码来确定的。掩码是一个32bit的值，其中值为1的比特留给网络号和子网号，为0的比特留给主机号。  
![两种不同的B类地址子网掩码的例子](https://github.com/Balabalabalala/Learning/images/2018-04-18_193750.png)  
图中第一个例子子网号和主机号都是8bit宽；第二个例子是一个B类地址划分成10bit的子网号和6bit的主机号。  
子网掩码常使用十六进制来表示，当界限不是一个字节时，子网掩码是一个比特掩码。  
在给定IP地址和子网掩码以后，主机就可以确定IP数据报的目的是本子网上的主机，本网络中其他子网中的主机还是其他网络上的主机。  
![使用子网掩码的两个B类地址之间的比较](https://github.com/Balabalabalala/Learning/images/2018-04-18_194812.png)  

### 特殊情况的IP地址





























## 参考链接
[1] 令牌环网 https://baike.baidu.com/item/令牌环网/2076446?fr=aladdin

[2] 令牌环 http://218.94.65.67:8028/ebook/4/juyuwan/jy073.htm
